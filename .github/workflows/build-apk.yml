name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    container: kivy/buildozer:latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Check files
      run: |
        ls -la
        cat buildozer.spec
        cat main.py | head -20
    
    - name: Build APK with Docker
      run: |
        # Build using pre-configured environment
        buildozer android debug 2>&1 | tee build.log
      env:
        BUILDOZER_WARN_ON_ROOT: 0
      timeout-minutes: 45
    
    - name: Find APK
      run: |
        echo "=== Find all APK files ==="
        find / -name "*.apk" -type f 2>/dev/null | head -10
        
        echo "=== Check bin directory ==="
        ls -la bin/ 2>/dev/null || echo "No bin"
        
        echo "=== Check .buildozer ==="
        find .buildozer -name "*.apk" 2>/dev/null | head -5
        
        # Copy to accessible location
        mkdir -p output
        find . -name "*.apk" -exec cp {} output/ \; 2>/dev/null || true
        ls -la output/
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dubbing-pro-apk
        path: |
          output/*.apk
          bin/*.apk
          **/*.apk
          build.log
        retention-days: 30
        if-no-files-found: warn
